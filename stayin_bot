from typing import Final
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    ContextTypes, CallbackQueryHandler, filters
)
from apscheduler.schedulers.asyncio import AsyncIOScheduler
import asyncio
import nest_asyncio

# -------------------- CONFIG --------------------
TOKEN: Final = "8437889078:AAEBcGd-lhd4ANKJ9pqsX1IpGOPMnx6YvFg"   # BotFather token
GROUP_CHAT_ID: Final = -1001809106961         # your group chat ID
TIMEZONE = "Asia/Singapore"
# ------------------------------------------------

staying_tonight: list[str] = []

# -------------------- COMMANDS --------------------

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.chat.type == "private":
        await update.message.reply_text(
            "Hi! üëã\n\n"
            "Send me your name to indicate you're staying in tonight.\n\n"
            "Example:\n"
            "John Tan\n\n"
            "üìã I will send the list to the group at 9:00 PM.\n"
            "üßπ The list resets automatically at 12:00 AM."
        )
    else:
        await update.message.reply_text(
            "Please message me privately to indicate you're staying in."
        )

# Receive name (PRIVATE CHAT ONLY)
async def receive_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message

    if message.chat.type != "private":
        return

    name = message.text.strip()

    if not name:
        await message.reply_text("Please send your name.")
        return

    name = name.title()

    if name not in staying_tonight:
        staying_tonight.append(name)
        await message.reply_text(
            f"‚úÖ Added: {name}\n"
            "I‚Äôll update the group at 9:00 PM."
        )
    else:
        await message.reply_text(f"‚ÑπÔ∏è {name} is already on the list.")

# /list (optional, works anywhere)
async def list_staying(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if staying_tonight:
        await update.message.reply_text(
            "üè† Staying tonight:\n" + "\n".join(staying_tonight)
        )
    else:
        await update.message.reply_text("No one is staying in yet.")

# /remove (optional)
async def remove_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not staying_tonight:
        await update.message.reply_text("The list is empty.")
        return

    keyboard = [
        [InlineKeyboardButton(name, callback_data=f"remove:{name}")]
        for name in staying_tonight
    ]

    await update.message.reply_text(
        "Select a name to remove:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# Handle remove buttons
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data.startswith("remove:"):
        name = query.data.split(":", 1)[1]

        if name in staying_tonight:
            staying_tonight.remove(name)
            await query.edit_message_text(f"‚ùå Removed: {name}")
        else:
            await query.edit_message_text("Name not found.")

# -------------------- SCHEDULED JOBS --------------------

# 9 PM: send list to group (DO NOT clear)
async def send_list_9pm(bot):
    summary = (
        "üìã Tonight's staying list:\n" +
        ("\n".join(staying_tonight) if staying_tonight else "No one is staying in.")
    )

    await bot.send_message(chat_id=GROUP_CHAT_ID, text=summary)

# 12 AM: clear list only
async def clear_list_midnight():
    staying_tonight.clear()
    print("üßπ Staying list cleared at 12:00 AM")

# -------------------- MAIN --------------------
async def main():
    app = Application.builder().token(TOKEN).build()

    # Handlers
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("list", list_staying))
    app.add_handler(CommandHandler("remove", remove_name))
    app.add_handler(
        MessageHandler(filters.TEXT & ~filters.COMMAND, receive_name)
    )
    app.add_handler(CallbackQueryHandler(button_handler))

    # Scheduler (Singapore time)
    scheduler = AsyncIOScheduler(timezone=TIMEZONE)

    # 9 PM ‚Üí send list
    scheduler.add_job(
        send_list_9pm,
        "cron",
        hour=21,
        minute=00,
        args=[app.bot]
    )

    # 12 AM ‚Üí clear list
    scheduler.add_job(
        clear_list_midnight,
        "cron",
        hour=0,
        minute=0
    )

    scheduler.start()

    print("‚úÖ Stay-in bot is running...")
    await app.run_polling()

# -------------------- PYTHONANYWHERE FRIENDLY --------------------
if __name__ == "__main__":
    nest_asyncio.apply()
    loop = asyncio.get_event_loop()
    loop.create_task(main())
    loop.run_forever()
